// Geocoder Nominatim for OpenLayers 3.
// https://github.com/jonataswalker/ol3-geocoder
// Version: v1.7.0
// Built: 2016-04-01T08:24:58-0300

"use strict";!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):e.Geocoder=t()}(this,function(){var e={},t={whiteSpaceRegex:/\s+/,toQueryString:function(e){return Object.keys(e).reduce(function(r,n){return r.push("object"==typeof e[n]?t.toQueryString(e[n]):encodeURIComponent(n)+"="+encodeURIComponent(e[n])),r},[]).join("&")},encodeUrlXhr:function(e,r){if(r&&"object"==typeof r){var n=t.toQueryString(r);e+=(/\?/.test(e)?"&":"?")+n}return e},json:function(e,r){var n=new XMLHttpRequest,o={},s=function(){200===n.status&&o.ready.call(void 0,JSON.parse(n.response))},a=function(){console.info("Cannot XHR "+JSON.stringify(e))};return e=t.encodeUrlXhr(e,r),n.open("GET",e,!0),n.setRequestHeader("Accept","application/json"),n.onload=s,n.onerror=a,n.send(null),{when:function(e){o.ready=e.ready}}},randomId:function(e){var t=(new Date).getTime().toString(36);return e?e+t:t},to3857:function(e){return ol.proj.transform([parseFloat(e[0]),parseFloat(e[1])],"EPSG:4326","EPSG:3857")},to4326:function(e){return ol.proj.transform([parseFloat(e[0]),parseFloat(e[1])],"EPSG:3857","EPSG:4326")},isNumeric:function(e){return/^\d+$/.test(e)},classRegex:function(e){return new RegExp("(^|\\s+)"+e+"(\\s+|$)")},addClass:function(e,r,n){if(Array.isArray(e))return void e.forEach(function(e){t.addClass(e,r)});for(var o=Array.isArray(r)?r:r.split(/\s+/),s=o.length;s--;)t.hasClass(e,o[s])||t._addClass(e,o[s],n)},_addClass:function(e,r,n){e.classList?e.classList.add(r):e.className=(e.className+" "+r).trim(),n&&t.isNumeric(n)&&window.setTimeout(function(){t._removeClass(e,r)},n)},removeClass:function(e,r,n){if(Array.isArray(e))return void e.forEach(function(e){t.removeClass(e,r,n)});for(var o=Array.isArray(r)?r:r.split(/\s+/),s=o.length;s--;)t.hasClass(e,o[s])&&t._removeClass(e,o[s],n)},_removeClass:function(e,r,n){e.classList?e.classList.remove(r):e.className=e.className.replace(t.classRegex(r)," ").trim(),n&&t.isNumeric(n)&&window.setTimeout(function(){t._addClass(e,r)},n)},hasClass:function(e,r){return e.classList?e.classList.contains(r):t.classRegex(r).test(e.className)},toggleClass:function(e,r){return Array.isArray(e)?void e.forEach(function(e){t.toggleClass(e,r)}):void(e.classList?e.classList.toggle(r):t.hasClass(e,r)?t._removeClass(e,r):t._addClass(e,r))},$:function(e){return e="#"===e[0]?e.substr(1,e.length):e,document.getElementById(e)},isElement:function(e){return"HTMLElement"in window?!!e&&e instanceof HTMLElement:!!e&&"object"==typeof e&&1===e.nodeType&&!!e.nodeName},getAllChildren:function(e,t){return[].slice.call(e.getElementsByTagName(t))},isEmpty:function(e){return!e||0===e.length},emptyArray:function(e){for(;e.length;)e.pop()},anyMatchInArray:function(e,t){return e.some(function(e){return t.indexOf(e)>=0})},everyMatchInArray:function(e,t){return t.every(function(t){return e.indexOf(t)>=0})},anyItemHasValue:function(e){var r=!1;for(var n in e)t.isEmpty(e[n])||(r=!0);return r},removeAllChildren:function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},removeAll:function(e){for(var t;t=e[0];)t.parentNode.removeChild(t)},getChildren:function(e,t){return[].filter.call(e.childNodes,function(e){return t?1==e.nodeType&&e.tagName.toLowerCase()==t:1==e.nodeType})},template:function(e,t){var r=this;return e.replace(/\{ *([\w_-]+) *\}/g,function(e,n){var o=void 0===t[n]?"":t[n];return r.htmlEscape(o)})},htmlEscape:function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},mergeOptions:function(e,t){var r={};for(var n in e)r[n]=e[n];for(var o in t)r[o]=t[o];return r},createElement:function(e,t){var r;if(Array.isArray(e)){if(r=document.createElement(e[0]),e[1].id&&(r.id=e[1].id),e[1].classname&&(r.className=e[1].classname),e[1].attr){var n=e[1].attr;if(Array.isArray(n))for(var o=-1;++o<n.length;)r.setAttribute(n[o].name,n[o].value);else r.setAttribute(n.name,n.value)}}else r=document.createElement(e);r.innerHTML=t;for(var s=document.createDocumentFragment();r.childNodes[0];)s.appendChild(r.childNodes[0]);return r.appendChild(s),r},assert:function(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}},assertEqual:function(e,t,r){if(e!=t)throw new Error(r+" mismatch: "+e+" != "+t)}};return e.Base=function(r,n){t.assert("string"==typeof r,"@param `control_type` should be string type!"),t.assert("object"==typeof n||"undefined"==typeof n,"@param `opt_options` should be object|undefined type!"),r=r||"nominatim",e.$base=this,e.$nominatim=new e.Nominatim(n),ol.control.Control.call(this,{element:e.$nominatim.container})},ol.inherits(e.Base,ol.control.Control),e.Base.prototype.getSource=function(){return this.getLayer().getSource()},e.Base.prototype.getLayer=function(){return e.$nominatim.layer},e.Nominatim=function(r){this.layer_name=t.randomId("geocoder-layer-"),this.layer=new ol.layer.Vector({name:this.layer_name,source:new ol.source.Vector});var n={provider:"osm",placeholder:"Search for an address",featureStyle:e.Nominatim.featureStyle,lang:"en-US",limit:5,keepOpen:!1,debug:!1};return this.options=t.mergeOptions(n,r),this.options.provider=this.options.provider.toLowerCase(),this.constants={road:"ol-geocoder-road",city:"ol-geocoder-city",country:"ol-geocoder-country",class_container:"ol-geocoder",expanded_class:"ol-geocoder-search-expanded"},this.container=this.createControl(),this.els=e.Nominatim.elements,this.registered_listeners={map_click:!1},this.setListeners(),this},e.Nominatim.prototype={createControl:function(){var r=t.createElement(["div",{classname:this.constants.class_container}],e.Nominatim.html);return e.Nominatim.elements={container:r,control:r.querySelector(".ol-geocoder-search"),btn_search:r.querySelector(".ol-geocoder-btn-search"),input_search:r.querySelector(".ol-geocoder-input-search"),result_container:r.querySelector(".ol-geocoder-result")},e.Nominatim.elements.input_search.placeholder=this.options.placeholder,r},setListeners:function(){var e=this,r=function(){t.hasClass(e.els.control,e.constants.expanded_class)?e.collapse():e.expand()},n=function(r){if(13==r.keyCode){var n=t.htmlEscape(e.els.input_search.value);e.query(n)}};e.els.input_search.addEventListener("keydown",n,!1),e.els.btn_search.addEventListener("click",r,!1)},listenMapClick:function(){if(!this.registered_listeners.map_click){var t=this,r=e.$base.getMap().getTargetElement();this.registered_listeners.map_click=!0,r.addEventListener("click",{handleEvent:function(e){t.clearResults(!0),r.removeEventListener(e.type,this,!1),t.registered_listeners.map_click=!1}},!1)}},expand:function(){t.removeClass(this.els.input_search,"ol-geocoder-loading"),t.addClass(this.els.control,this.constants.expanded_class);var e=this.els.input_search;window.setTimeout(function(){e.focus()},100),this.listenMapClick()},collapse:function(){this.els.input_search.value="",this.els.input_search.blur(),t.removeClass(this.els.control,this.constants.expanded_class),this.clearResults()},clearResults:function(e){e?this.collapse():t.removeAllChildren(this.els.result_container)},query:function(r){var n=this,o=this.options,s=this.els.input_search,a=e.Nominatim.providers.names,i=this.getProvider({provider:o.provider,key:o.key,query:r,lang:o.lang,countrycodes:o.countrycodes,limit:o.limit});this.clearResults(),t.addClass(s,"ol-geocoder-loading"),t.json(i.url,i.params).when({ready:function(e){o.debug&&console.info(e),t.removeClass(s,"ol-geocoder-loading");var r;switch(n.options.provider){case a.OSM:case a.MAPQUEST:r=e.length>0?n.mapquestResponse(e):void 0;break;case a.PELIAS:r=e.features.length>0?n.peliasResponse(e.features):void 0;break;case a.PHOTON:r=e.features.length>0?n.photonResponse(e.features):void 0;break;case a.GOOGLE:r=e.results.length>0?n.googleResponse(e.results):void 0}r&&(n.createList(r),n.listenMapClick())},error:function(){t.removeClass(s,"ol-geocoder-loading");var e=t.createElement("li","<h5>Error! No internet connection?</h5>");n.els.result_container.appendChild(e)}})},createList:function(e){var r=this,n=this.els.result_container;e.forEach(function(e){var o=r.addressTemplate(e),s='<a href="#">'+o+"</a>",a=t.createElement("li",s);a.addEventListener("click",function(t){t.preventDefault(),r.chosen(e,o,e.address,e.original)},!1),n.appendChild(a)})},addressTemplate:function(e){var r=e.address,n=[];return r.name&&n.push('<span class="'+this.constants.road+'">{name}</span>'),(r.road||r.building||r.house_number)&&n.push('<span class="'+this.constants.road+'">{building} {road} {house_number}</span>'),(r.city||r.town||r.village)&&n.push('<span class="'+this.constants.city+'">{postcode} {city} {town} {village}</span>'),(r.state||r.country)&&n.push('<span class="'+this.constants.country+'">{state} {country}</span>'),t.template(n.join("<br>"),r)},chosen:function(t,r,n,o){this.options.keepOpen===!1&&this.clearResults(!0);var s=e.$base.getMap(),a=s.getView(),i=a.getProjection(),l=ol.proj.transform([parseFloat(t.lon),parseFloat(t.lat)],"EPSG:4326",i),c=2.388657133911758,d=500,u={coord:l,address_html:r,address_obj:n,address_original:o},p=ol.animation.pan({duration:d,source:a.getCenter()}),m=ol.animation.zoom({duration:d,resolution:a.getResolution()});s.beforeRender(p,m),a.setCenter(l),a.setResolution(c),this.createFeature(u)},createFeature:function(r){var n=new ol.Feature({address_html:r.address_html,address_obj:r.address_obj,address_original:r.address_original,geometry:new ol.geom.Point(r.coord)}),o=t.randomId("geocoder-ft-"),s=this.options.featureStyle||e.Nominatim.featureStyle;this.addLayer(),n.setStyle(s),n.setId(o),this.getSource().addFeature(n),e.$base.dispatchEvent({type:e.EventType.ADDRESSCHOSEN,feature:n,coordinate:r.coord})},mapquestResponse:function(e){var t=e.map(function(e){return{lon:e.lon,lat:e.lat,address:{name:e.address.neighbourhood||"",road:e.address.road||"",postcode:e.address.postcode,city:e.address.city||e.address.town,state:e.address.state,country:e.address.country},original:{formatted:e.display_name,details:e.address}}});return t},photonResponse:function(e){var t=e.map(function(e){return{lon:e.geometry.coordinates[0],lat:e.geometry.coordinates[1],address:{name:e.properties.name,postcode:e.properties.postcode,city:e.properties.city,state:e.properties.state,country:e.properties.country},original:{formatted:e.properties.name,details:e.properties}}});return t},peliasResponse:function(e){var t=e.map(function(e){return{lon:e.geometry.coordinates[0],lat:e.geometry.coordinates[1],address:{name:e.properties.name,house_number:e.properties.housenumber,postcode:e.properties.postalcode,road:e.properties.street,city:e.properties.city,state:e.properties.region,country:e.properties.country},original:{formatted:e.properties.label,details:e.properties}}});return t},googleResponse:function(e){var r=["point_of_interest","establishment","natural_feature","airport"],n=["street_address","route","sublocality_level_5","intersection"],o=["postal_code"],s=["locality"],a=["administrative_area_level_1"],i=["country"],l=function(e){var l={name:"",road:"",postcode:"",city:"",state:"",country:""};return e.forEach(function(e){t.anyMatchInArray(e.types,r)?l.name=e.long_name:t.anyMatchInArray(e.types,n)?l.road=e.long_name:t.anyMatchInArray(e.types,o)?l.postcode=e.long_name:t.anyMatchInArray(e.types,s)?l.city=e.long_name:t.anyMatchInArray(e.types,a)?l.state=e.long_name:t.anyMatchInArray(e.types,i)&&(l.country=e.long_name)}),l},c=[];return e.forEach(function(e){var r=l(e.address_components);t.anyItemHasValue(r)&&c.push({lon:e.geometry.location.lng,lat:e.geometry.location.lat,address:{name:r.name,postcode:r.postcode,road:r.road,city:r.city,state:r.state,country:r.country},original:{formatted:e.formatted_address,details:e.address_components}})}),c},getSource:function(){return this.layer.getSource()},addLayer:function(){var t=this,r=!1,n=e.$base.getMap();n.getLayers().forEach(function(e){e===t.layer&&(r=!0)}),r||n.addLayer(this.layer)},getProvider:function(r){var n,o=e.Nominatim.providers[r.provider],s=e.Nominatim.providers.names,a=[s.MAPQUEST,s.PELIAS,s.GOOGLE],i=["de","it","fr","en"];switch(r.provider){case s.OSM:case s.MAPQUEST:n={q:r.query,limit:r.limit,countrycodes:r.countrycodes,"accept-language":r.lang},o.params=t.mergeOptions(o.params,n);break;case s.PHOTON:r.lang=r.lang.toLowerCase(),n={q:r.query,limit:r.limit||o.params.limit,lang:i.indexOf(r.lang)>-1?r.lang:o.params.lang},o.params=t.mergeOptions(o.params,n);break;case s.GOOGLE:n={address:r.query,language:r.lang},o.params=t.mergeOptions(o.params,n);break;case s.PELIAS:n={text:r.query,size:r.limit},o.params=t.mergeOptions(o.params,n)}return a.indexOf(r.provider)>-1&&(o.params.key=r.key),o}},e.EventType={ADDRESSCHOSEN:"addresschosen"},e.Nominatim.elements={},e.Nominatim.providers={names:{OSM:"osm",MAPQUEST:"mapquest",GOOGLE:"google",PHOTON:"photon",PELIAS:"pelias"},osm:{url:"http://nominatim.openstreetmap.org/search/",params:{format:"json",q:"",addressdetails:1,limit:10,countrycodes:"","accept-language":"en-US"}},mapquest:{url:"http://open.mapquestapi.com/nominatim/v1/search.php",params:{key:"",format:"json",q:"",addressdetails:1,limit:10,countrycodes:"","accept-language":"en-US"}},google:{url:"https://maps.googleapis.com/maps/api/geocode/json",params:{key:"",address:"",language:"en-US"}},pelias:{url:"https://search.mapzen.com/v1/search",params:{key:"",text:"",size:10}},photon:{url:"http://photon.komoot.de/api/",params:{q:"",limit:10,lang:"en"}}},e.Nominatim.featureStyle=[new ol.style.Style({image:new ol.style.Icon({scale:.7,anchor:[.5,1],src:"//cdn.rawgit.com/jonataswalker/map-utils/master/images/marker.png"}),zIndex:5}),new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:[235,235,235,1]}),stroke:new ol.style.Stroke({color:[0,0,0,1]}),radius:5}),zIndex:4})],e.Nominatim.html=['<div class="ol-geocoder-search ol-control">','<button type="button" class="ol-geocoder-btn-search"></button>','<input type="text"',' class="ol-geocoder-input-search"',' placeholder="Search">',"</div>",'<ul class="ol-geocoder-result"></ul>'].join(""),e.Base});
